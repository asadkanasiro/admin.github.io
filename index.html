<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Zindagi Perfumes</title>
  <!-- Your CSS remains unchanged -->
  <style>
    /* [Your existing CSS here] */
  </style>
</head>
<body>
  <!-- Your HTML remains unchanged -->
  <div class="admin-container">
    <!-- [Your existing HTML here] -->
  </div>

  <!-- Edit Product Modal -->
  <div id="editProductModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editProductTitle">
    <!-- [Your existing modal HTML] -->
  </div>

  <!-- Add Product Modal -->
  <div id="addProductModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="addProductTitle">
    <!-- [Your existing modal HTML] -->
  </div>

  <!-- Loader -->
  <div id="loader" class="loader" aria-hidden="true">Loading...</div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { 
      getFirestore, collection, onSnapshot, doc, updateDoc, getDoc, addDoc, deleteDoc 
    } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC-sMxHYSiwld_U5GO7oGtHPw5CaVY_16s",
      authDomain: "zindagi-334b7.firebaseapp.com",
      databaseURL: "https://zindagi-334b7-default-rtdb.firebaseio.com",
      projectId: "zindagi-334b7",
      storageBucket: "zindagi-334b7.firebasestorage.app",
      messagingSenderId: "936307521870",
      appId: "1:936307521870:web:619c050d865cff2ac9861f",
      measurementId: "G-B4HP267SJF"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Temporary admin email (move to custom claims in production)
    const adminEmail = "admin@zindagiperfumes.com";

    // DOM Elements
    const loader = document.getElementById("loader");
    const editModal = document.getElementById("editProductModal");
    const addModal = document.getElementById("addProductModal");

    // Utility Functions
    const showLoader = () => loader.style.display = "block";
    const hideLoader = () => loader.style.display = "none";

    const openModal = (modal) => {
      modal.style.display = "flex";
      modal.classList.add("active");
      modal.querySelector("input, button").focus(); // Improve accessibility
    };

    const closeModal = (modal) => {
      modal.style.display = "none";
      modal.classList.remove("active");
    };

    // Sidebar Navigation
    const navLinks = document.querySelectorAll('.sidebar nav ul li a');
    const sections = document.querySelectorAll('.section');
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const sectionId = link.getAttribute('data-section');
        navLinks.forEach(n => n.classList.remove('active'));
        sections.forEach(sec => sec.classList.remove('active'));
        link.classList.add('active');
        document.getElementById(sectionId).classList.add('active');
      });
    });

    // Authentication Check
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "public.html";
        return;
      }
      if (user.email !== adminEmail) { // Replace with custom claims in production
        alert("Access denied. Admins only.");
        signOut(auth).then(() => window.location.href = "public.html");
        return;
      }
      // Load data only for authorized admin
      initializeAdminDashboard();
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
      signOut(auth).then(() => window.location.href = "public.html");
    });

    // Initialize Dashboard
    function initializeAdminDashboard() {
      loadDashboardStats();
      loadProducts();
      loadOrders();
      loadContacts();
      loadSubscribers();
      setupModalListeners();
    }

    // Load Dashboard Stats
    async function loadDashboardStats() {
      showLoader();
      try {
        onSnapshot(collection(db, "products"), (snap) => {
          document.getElementById("totalProducts").textContent = snap.size;
        });
        onSnapshot(collection(db, "orders"), (snap) => {
          document.getElementById("totalOrders").textContent = snap.size;
        });
        onSnapshot(collection(db, "contacts"), (snap) => {
          document.getElementById("totalContacts").textContent = snap.size;
        });
        onSnapshot(collection(db, "subscribers"), (snap) => {
          document.getElementById("totalSubscribers").textContent = snap.size;
        });
      } catch (err) {
        console.error("Error loading stats:", err);
        alert("Failed to load dashboard stats.");
      } finally {
        hideLoader();
      }
    }

    // Load Products
    function loadProducts() {
      const productsDiv = document.getElementById("productsList");
      showLoader();
      onSnapshot(collection(db, "products"), (snapshot) => {
        productsDiv.innerHTML = "";
        snapshot.forEach(docSnap => {
          const product = { id: docSnap.id, ...docSnap.data() };
          const productDiv = document.createElement("div");
          productDiv.classList.add("product-item");
          productDiv.innerHTML = `
            <strong>${product.name}</strong> - PKR ${product.price}<br>
            ${product.description || ''}<br>
            <button class="edit-btn" data-id="${product.id}">Edit</button>
            <button class="delete-btn" data-id="${product.id}">Delete</button>
          `;
          productsDiv.appendChild(productDiv);
        });
        hideLoader();
      }, (err) => {
        console.error("Error loading products:", err);
        alert("Failed to load products.");
        hideLoader();
      });
    }

    // Load Orders
    function loadOrders() {
      const ordersDiv = document.getElementById("ordersList");
      showLoader();
      onSnapshot(collection(db, "orders"), (snapshot) => {
        ordersDiv.innerHTML = "";
        snapshot.forEach(docSnap => {
          const order = docSnap.data();
          const orderDiv = document.createElement("div");
          orderDiv.classList.add("order-item");
          orderDiv.textContent = `Order ${order.orderId} by ${order.customerEmail} - Total: PKR ${order.amount}`;
          ordersDiv.appendChild(orderDiv);
        });
        hideLoader();
      });
    }

    // Load Contacts
    function loadContacts() {
      const contactsDiv = document.getElementById("contactsList");
      showLoader();
      onSnapshot(collection(db, "contacts"), (snapshot) => {
        contactsDiv.innerHTML = "";
        snapshot.forEach(docSnap => {
          const contact = docSnap.data();
          const contactDiv = document.createElement("div");
          contactDiv.classList.add("contact-item");
          contactDiv.textContent = `${contact.name} (${contact.email}): ${contact.message}`;
          contactsDiv.appendChild(contactDiv);
        });
        hideLoader();
      });
    }

    // Load Subscribers
    function loadSubscribers() {
      const subsDiv = document.getElementById("subscribersList");
      showLoader();
      onSnapshot(collection(db, "subscribers"), (snapshot) => {
        subsDiv.innerHTML = "";
        snapshot.forEach(docSnap => {
          const subscriber = docSnap.data();
          const subDiv = document.createElement("div");
          subDiv.classList.add("subscriber-item");
          subDiv.textContent = subscriber.email;
          subsDiv.appendChild(subDiv);
        });
        hideLoader();
      });
    }

    // Setup Modal Listeners
    function setupModalListeners() {
      // Edit Modal
      const editProductForm = document.getElementById("editProductForm");
      document.getElementById("closeEditModal").addEventListener("click", () => closeModal(editModal));
      editProductForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        showLoader();
        const productId = document.getElementById("editProductId").value;
        const updatedData = {
          name: document.getElementById("editProductName").value,
          price: parseFloat(document.getElementById("editProductPrice").value),
          description: document.getElementById("editProductDesc").value,
        };
        try {
          await updateDoc(doc(db, "products", productId), updatedData);
          alert("Product updated successfully!");
          closeModal(editModal);
        } catch (err) {
          console.error("Error updating product:", err);
          alert("Failed to update product.");
        } finally {
          hideLoader();
        }
      });

      // Add Modal
      const addProductForm = document.getElementById("addProductForm");
      document.getElementById("closeAddModal").addEventListener("click", () => closeModal(addModal));
      document.getElementById("addProductBtn").addEventListener("click", () => {
        addProductForm.reset();
        openModal(addModal);
      });
      addProductForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        showLoader();
        const newProduct = {
          name: document.getElementById("addProductName").value,
          price: parseFloat(document.getElementById("addProductPrice").value),
          description: document.getElementById("addProductDesc").value,
          imageUrl: document.getElementById("addProductImage").value
        };
        try {
          await addDoc(collection(db, "products"), newProduct);
          alert("Product added successfully!");
          closeModal(addModal);
        } catch (err) {
          console.error("Error adding product:", err);
          alert("Failed to add product.");
        } finally {
          hideLoader();
        }
      });

      // Edit/Delete Button Handlers
      document.getElementById("productsList").addEventListener("click", (e) => {
        const target = e.target;
        if (target.classList.contains("edit-btn")) {
          openEditModal(target.getAttribute("data-id"));
        } else if (target.classList.contains("delete-btn")) {
          if (confirm("Are you sure you want to delete this product?")) {
            deleteDoc(doc(db, "products", target.getAttribute("data-id")))
              .then(() => alert("Product deleted successfully."))
              .catch(err => alert("Failed to delete product: " + err.message));
          }
        }
      });
    }

    // Open Edit Modal
    async function openEditModal(productId) {
      showLoader();
      try {
        const productRef = doc(db, "products", productId);
        const docSnap = await getDoc(productRef);
        if (docSnap.exists()) {
          const product = docSnap.data();
          document.getElementById("editProductId").value = productId;
          document.getElementById("editProductName").value = product.name;
          document.getElementById("editProductPrice").value = product.price;
          document.getElementById("editProductDesc").value = product.description || "";
          openModal(editModal);
        } else {
          alert("Product not found.");
        }
      } catch (err) {
        console.error("Error fetching product:", err);
        alert("Failed to load product details.");
      } finally {
        hideLoader();
      }
    }
  </script>
</body>
</html>