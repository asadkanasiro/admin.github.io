<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Zindagi Perfumes</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
    body { background: #f4f1e9; color: #2c3e50; line-height: 1.5; }
    .login-container, .admin-container { display: none; min-height: 100vh; }
    .login-container.active, .admin-container.active { display: block; }
    .login-card { background: #fff; padding: 2.5rem; border-radius: 8px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); width: 100%; max-width: 420px; margin: 5rem auto; text-align: center; }
    .login-card h2 { font-size: 1.75rem; font-weight: 500; margin-bottom: 2rem; color: #d4a017; }
    .login-container input { width: 100%; padding: 0.85rem; margin: 0.75rem 0; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem; transition: border-color 0.3s; }
    .login-container input:focus { border-color: #d4a017; outline: none; }
    .login-container button, .action-btn { background: #d4a017; border: none; color: #fff; padding: 0.85rem 1.5rem; border-radius: 4px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background 0.3s; }
    .login-container button:hover, .action-btn:hover { background: #b58900; }
    .error-message { color: #c0392b; margin-top: 1rem; font-size: 0.9rem; }
    .admin-container { padding: 1rem; }
    .sidebar { background: #2c3e50; color: #ecf0f1; position: fixed; top: 0; left: -280px; width: 280px; height: 100vh; transition: left 0.3s; z-index: 1001; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2); }
    .sidebar.active { left: 0; }
    .sidebar header { padding: 2rem 1.5rem; border-bottom: 1px solid #34495e; text-align: center; }
    .sidebar header h2 { font-size: 1.5rem; font-weight: 700; color: #d4a017; }
    .sidebar header img { max-width: 100px; margin-bottom: 1rem; }
    .sidebar nav ul { list-style: none; padding: 1rem 0; }
    .sidebar nav ul li a { display: block; padding: 1rem 1.5rem; color: #bdc3c7; text-decoration: none; font-size: 1.1rem; transition: all 0.3s; }
    .sidebar nav ul li a:hover, .sidebar nav ul li a.active { background: #34495e; color: #d4a017; }
    .sidebar footer { padding: 1.5rem; border-top: 1px solid #34495e; }
    .sidebar footer button { width: 100%; background: #d4a017; padding: 0.85rem; border-radius: 4px; }
    .menu-toggle { background: #2c3e50; color: #ecf0f1; border: none; padding: 1rem; font-size: 1.5rem; cursor: pointer; position: fixed; left: 1rem; top: 1rem; z-index: 1002; border-radius: 4px; }
    .menu-toggle:hover { background: #34495e; }
    .content { margin-left: 0; transition: margin-left 0.3s; }
    .content.active { margin-left: 280px; }
    .section { background: #fff; padding: 2rem; border-radius: 8px; border: 1px solid #e0e4e8; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 1.5rem; }
    .section h2 { font-size: 1.75rem; font-weight: 500; color: #d4a017; margin-bottom: 1.5rem; }
    .search-bar { margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: center; }
    .search-bar input, .search-bar select { padding: 0.85rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem; }
    .stats-grid, .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card, .card { background: #fff; padding: 1.5rem; border-radius: 8px; border: 1px solid #e0e4e8; text-align: center; }
    .stat-card:hover, .card:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .stat-card span { font-size: 2.25rem; font-weight: 700; color: #d4a017; margin-bottom: 0.5rem; display: block; }
    .card img { max-width: 100%; border-radius: 4px; margin: 0.5rem 0; }
    .card .actions { margin-top: 1rem; }
    .action-btn.edit-btn { background: #d4a017; }
    .action-btn.edit-btn:hover { background: #b58900; }
    .action-btn.delete-btn { background: #c0392b; }
    .action-btn.delete-btn:hover { background: #a73125; }
    .export-btn { background: #3498db; }
    .export-btn:hover { background: #2980b9; }
    .pagination { display: flex; justify-content: space-between; margin-top: 1rem; }
    .pagination button { padding: 0.5rem 1rem; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: #fff; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; }
    .modal-content input[type="file"] { padding: 0.5rem 0; }
    .close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #7f8c8d; }
    .loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(44, 62, 80, 0.9); color: #fff; padding: 1rem 2rem; border-radius: 4px; display: none; z-index: 1001; }
    .notifications { position: fixed; top: 1rem; right: 1rem; background: #fff; padding: 1rem; border-radius: 4px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); z-index: 1000; display: none; }
    .notification { padding: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #e0e4e8; }
    .chart-container { width: 100%; max-width: 600px; margin: 2rem auto; }
    @media (max-width: 768px) {
      .menu-toggle { display: block; }
      .sidebar { left: -280px; }
      .content.active { margin-left: 0; padding-top: 4rem; }
      .stats-grid, .cards-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Login Form -->
  <div class="login-container active" id="loginContainer">
    <div class="login-card">
      <h2>Zindagi Perfumes Admin</h2>
      <input type="email" id="email" placeholder="Email Address" />
      <input type="password" id="password" placeholder="Password" />
      <button id="loginBtn">Sign In</button>
      <div id="loginError" class="error-message"></div>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div class="admin-container" id="adminContainer">
    <button class="menu-toggle" id="menuToggle">☰</button>
    <aside class="sidebar">
      <header>
        <img src="https://via.placeholder.com/100?text=ZP" alt="Zindagi Perfumes Logo" />
        <h2>Zindagi Perfumes</h2>
      </header>
      <nav>
        <ul>
          <li><a href="#" data-section="dashboard" class="active">Dashboard</a></li>
          <li><a href="#" data-section="products">Products</a></li>
          <li><a href="#" data-section="orders">Orders</a></li>
        </ul>
      </nav>
      <footer><button id="logoutBtn">Sign Out</button></footer>
    </aside>
    <main class="content">
      <section id="dashboard" class="section active">
        <h2>Dashboard</h2>
        <div class="stats-grid">
          <div class="stat-card"><span id="totalProducts">0</span><p>Total Products</p></div>
          <div class="stat-card"><span id="totalOrders">0</span><p>Total Orders</p></div>
          <div class="stat-card"><span id="totalRevenue">0</span><p>Total Revenue (PKR)</p></div>
        </div>
        <div class="chart-container">
          <canvas id="revenueChart"></canvas>
        </div>
      </section>
      <section id="products" class="section">
        <h2>Products</h2>
        <div class="search-bar">
          <input type="text" id="productSearch" placeholder="Search products..." />
          <select id="productSort">
            <option value="name">Sort by Name</option>
            <option value="price">Sort by Price</option>
          </select>
        </div>
        <button class="action-btn" id="addProductBtn">Add Product</button>
        <button class="action-btn export-btn" id="exportProductsBtn">Export Products</button>
        <div class="cards-grid" id="productsCards"></div>
        <div class="pagination">
          <button id="prevProducts">Previous</button>
          <span id="productsPage">Page 1</span>
          <button id="nextProducts">Next</button>
        </div>
      </section>
      <section id="orders" class="section">
        <h2>Orders</h2>
        <div class="search-bar">
          <input type="text" id="orderSearch" placeholder="Search orders..." />
          <select id="orderSort">
            <option value="orderId">Sort by Order ID</option>
            <option value="amount">Sort by Amount</option>
          </select>
        </div>
        <button class="action-btn export-btn" id="exportOrdersBtn">Export Orders</button>
        <div class="cards-grid" id="ordersCards"></div>
        <div class="pagination">
          <button id="prevOrders">Previous</button>
          <span id="ordersPage">Page 1</span>
          <button id="nextOrders">Next</button>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals -->
  <div id="addProductModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeAddModal">×</button>
      <h3>Add Product</h3>
      <form id="addProductForm">
        <label>Name</label><input type="text" id="addName" required />
        <label>Price (PKR)</label><input type="number" id="addPrice" step="0.01" required />
        <label>Description</label><textarea id="addDesc" required></textarea>
        <label>Image</label><input type="file" id="addImage" accept="image/*" required />
        <button type="submit" class="action-btn">Add Product</button>
      </form>
    </div>
  </div>
  <div id="editProductModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeEditModal">×</button>
      <h3>Edit Product</h3>
      <form id="editProductForm">
        <input type="hidden" id="editId" />
        <label>Name</label><input type="text" id="editName" required />
        <label>Price (PKR)</label><input type="number" id="editPrice" step="0.01" required />
        <label>Description</label><textarea id="editDesc" required></textarea>
        <label>Image</label><input type="file" id="editImage" accept="image/*" />
        <button type="submit" class="action-btn">Save Changes</button>
      </form>
    </div>
  </div>
  <div id="updateOrderModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeOrderModal">×</button>
      <h3>Update Order Status</h3>
      <form id="updateOrderForm">
        <input type="hidden" id="orderId" />
        <label>Status</label>
        <select id="orderStatus" required>
          <option value="Pending">Pending</option>
          <option value="Shipped">Shipped</option>
          <option value="Delivered">Delivered</option>
        </select>
        <button type="submit" class="action-btn">Update Status</button>
      </form>
    </div>
  </div>

  <div id="loader" class="loader">Loading...</div>
  <div id="notifications" class="notifications"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, limit, startAfter } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-storage.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";

    // Replace with your Firebase project configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC-sMxHYSiwld_U5GO7oGtHPw5CaVY_16s",
      authDomain: "zindagi-334b7.firebaseapp.com",
      databaseURL: "https://zindagi-334b7-default-rtdb.firebaseio.com",
      projectId: "zindagi-334b7",
      storageBucket: "zindagi-334b7.firebasestorage.app",
      messagingSenderId: "936307521870",
      appId: "1:936307521870:web:619c050d865cff2ac9861f",
      measurementId: "G-B4HP267SJF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // DOM Elements
    const loginContainer = document.getElementById("loginContainer");
    const adminContainer = document.getElementById("adminContainer");
    const menuToggle = document.getElementById("menuToggle");
    const sidebar = document.querySelector(".sidebar");
    const content = document.querySelector(".content");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginError = document.getElementById("loginError");
    const loader = document.getElementById("loader");
    const notifications = document.getElementById("notifications");
    const addProductBtn = document.getElementById("addProductBtn");
    const addProductModal = document.getElementById("addProductModal");
    const editProductModal = document.getElementById("editProductModal");
    const updateOrderModal = document.getElementById("updateOrderModal");
    const productsCards = document.getElementById("productsCards");
    const ordersCards = document.getElementById("ordersCards");
    const productSearch = document.getElementById("productSearch");
    const orderSearch = document.getElementById("orderSearch");
    const productSort = document.getElementById("productSort");
    const orderSort = document.getElementById("orderSort");
    const prevProducts = document.getElementById("prevProducts");
    const nextProducts = document.getElementById("nextProducts");
    const prevOrders = document.getElementById("prevOrders");
    const nextOrders = document.getElementById("nextOrders");
    const productsPage = document.getElementById("productsPage");
    const ordersPage = document.getElementById("ordersPage");
    const exportProductsBtn = document.getElementById("exportProductsBtn");
    const exportOrdersBtn = document.getElementById("exportOrdersBtn");

    // State
    let productsLastDoc = null, ordersLastDoc = null;
    let productsPageNum = 1, ordersPageNum = 1;
    const perPage = 5;

    // Utility Functions
    const showLoader = () => loader.style.display = "block";
    const hideLoader = () => loader.style.display = "none";
    const showLogin = () => { loginContainer.classList.add("active"); adminContainer.classList.remove("active"); };
    const showAdmin = () => { loginContainer.classList.remove("active"); adminContainer.classList.add("active"); };
    const openModal = (modal) => modal.classList.add("active");
    const closeModal = (modal) => modal.classList.remove("active");
    const toggleSidebar = () => { sidebar.classList.toggle("active"); content.classList.toggle("active"); };
    const showNotification = (message) => {
      const notification = document.createElement("div");
      notification.className = "notification";
      notification.textContent = message;
      notifications.appendChild(notification);
      notifications.style.display = "block";
      setTimeout(() => {
        notification.remove();
        if (!notifications.children.length) notifications.style.display = "none";
      }, 5000);
    };

    // Authentication State Listener
    onAuthStateChanged(auth, (user) => {
      console.log("Auth state changed:", user ? "User logged in" : "No user");
      showLoader();
      if (user) {
        console.log("User email:", user.email);
        user.getIdTokenResult()
          .then(idTokenResult => {
            console.log("Custom claims:", idTokenResult.claims);
            if (idTokenResult.claims.admin) {
              console.log("User is admin, showing dashboard");
              showAdmin();
              initializeAdminDashboard(idTokenResult.claims.role || "viewer");
            } else {
              console.log("User is not admin, signing out");
              signOut(auth);
              showLogin();
              loginError.textContent = "Access denied. Admins only.";
            }
          })
          .catch(err => {
            console.error("Error fetching token result:", err);
            showLogin();
            loginError.textContent = "Authentication error: " + err.message;
          })
          .finally(() => hideLoader());
      } else {
        console.log("No user, showing login");
        showLogin();
        loginError.textContent = "";
        hideLoader();
      }
    });

    // Login Handler
    loginBtn.addEventListener("click", () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) {
        loginError.textContent = "Please enter both email and password.";
        return;
      }
      showLoader();
      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          console.log("Sign-in successful:", userCredential.user.email);
          loginError.textContent = ""; // Clear error on success
        })
        .catch((err) => {
          console.error("Sign-in error:", err);
          loginError.textContent = `Login failed: ${err.message}`;
          hideLoader();
        });
    });

    logoutBtn.addEventListener("click", () => {
      console.log("Signing out");
      signOut(auth);
    });

    menuToggle.addEventListener("click", toggleSidebar);

    document.querySelectorAll('.sidebar nav ul li a').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.sidebar nav ul li a').forEach(n => n.classList.remove("active"));
        document.querySelectorAll('.section').forEach(s => s.classList.remove("active"));
        link.classList.add("active");
        document.getElementById(link.getAttribute('data-section')).classList.add("active");
        if (window.innerWidth <= 768) toggleSidebar();
      });
    });

    // Initialize Dashboard
    function initializeAdminDashboard(role) {
      console.log("Initializing dashboard for role:", role);
      loadDashboardStats();
      loadProducts();
      loadOrders();
      setupModalListeners(role);
      setupSearchAndSort();
      setupPagination();
      setupExport();
      setupChart();
    }

    // Dashboard Stats and Chart
    function loadDashboardStats() {
      showLoader();
      onSnapshot(collection(db, "products"), snap => {
        document.getElementById("totalProducts").textContent = snap.size;
      });
      onSnapshot(collection(db, "orders"), snap => {
        document.getElementById("totalOrders").textContent = snap.size;
        let totalRevenue = 0;
        const revenueData = [];
        snap.forEach(doc => {
          const order = doc.data();
          totalRevenue += order.amount || 0;
          revenueData.push({ x: doc.id, y: order.amount || 0 });
        });
        document.getElementById("totalRevenue").textContent = totalRevenue.toFixed(2);
        updateChart(revenueData);
        hideLoader();
      });
    }

    function setupChart() {
      const ctx = document.getElementById("revenueChart").getContext("2d");
      window.revenueChart = new Chart(ctx, {
        type: "line",
        data: { datasets: [{ label: "Revenue (PKR)", data: [], borderColor: "#d4a017", fill: false }] },
        options: { scales: { x: { title: { display: true, text: "Orders" } }, y: { beginAtZero: true, title: { display: true, text: "Amount (PKR)" } } } }
      });
    }

    function updateChart(data) {
      window.revenueChart.data.datasets[0].data = data;
      window.revenueChart.update();
    }

    // Products Management
    async function loadProducts(searchQuery = "", sortBy = "name") {
      showLoader();
      let q = query(collection(db, "products"), orderBy(sortBy), limit(perPage));
      if (productsLastDoc && productsPageNum > 1) q = query(q, startAfter(productsLastDoc));
      if (searchQuery) q = query(q, where("name", ">=", searchQuery), where("name", "<=", searchQuery + "\uf8ff"));
      const snap = await getDocs(q);
      productsCards.innerHTML = "";
      snap.forEach(doc => {
        const product = { id: doc.id, ...doc.data() };
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h4>${product.name}</h4>
          <p><strong>Price:</strong> ${product.price.toFixed(2)} PKR</p>
          <p><strong>Description:</strong> ${product.description}</p>
          ${product.imageUrl ? `<img src="${product.imageUrl}" alt="${product.name}">` : ""}
          <div class="actions">
            <button class="action-btn edit-btn" data-id="${product.id}">Edit</button>
            <button class="action-btn delete-btn" data-id="${product.id}">Delete</button>
          </div>
        `;
        productsCards.appendChild(card);
      });
      productsLastDoc = snap.docs[snap.docs.length - 1];
      productsPage.textContent = `Page ${productsPageNum}`;
      prevProducts.disabled = productsPageNum === 1;
      setupCardListeners();
      hideLoader();
    }

    // Orders Management
    async function loadOrders(searchQuery = "", sortBy = "orderId") {
      showLoader();
      let q = query(collection(db, "orders"), orderBy(sortBy), limit(perPage));
      if (ordersLastDoc && ordersPageNum > 1) q = query(q, startAfter(ordersLastDoc));
      if (searchQuery) q = query(q, where("orderId", ">=", searchQuery), where("orderId", "<=", searchQuery + "\uf8ff"));
      const snap = await getDocs(q);
      ordersCards.innerHTML = "";
      snap.forEach(doc => {
        const order = { id: doc.id, ...doc.data() };
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h4>Order #${order.orderId || order.id}</h4>
          <p><strong>Customer:</strong> ${order.customerEmail || "Unknown"}</p>
          <p><strong>Amount:</strong> ${order.amount.toFixed(2)} PKR</p>
          <p><strong>Status:</strong> ${order.status}</p>
          <div class="actions">
            <button class="action-btn" data-id="${order.id}" data-status="${order.status}">Update Status</button>
          </div>
        `;
        ordersCards.appendChild(card);
      });
      ordersLastDoc = snap.docs[snap.docs.length - 1];
      ordersPage.textContent = `Page ${ordersPageNum}`;
      prevOrders.disabled = ordersPageNum === 1;
      setupCardListeners();
      hideLoader();
    }

    // Search and Sort
    function setupSearchAndSort() {
      productSearch.addEventListener("input", debounce(() => loadProducts(productSearch.value, productSort.value), 300));
      orderSearch.addEventListener("input", debounce(() => loadOrders(orderSearch.value, orderSort.value), 300));
      productSort.addEventListener("change", () => loadProducts(productSearch.value, productSort.value));
      orderSort.addEventListener("change", () => loadOrders(orderSearch.value, orderSort.value));
    }

    function debounce(func, wait) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    }

    // Pagination
    function setupPagination() {
      prevProducts.addEventListener("click", () => {
        if (productsPageNum > 1) {
          productsPageNum--;
          productsLastDoc = null; // Reset for simplicity
          loadProducts(productSearch.value, productSort.value);
        }
      });
      nextProducts.addEventListener("click", () => {
        productsPageNum++;
        loadProducts(productSearch.value, productSort.value);
      });
      prevOrders.addEventListener("click", () => {
        if (ordersPageNum > 1) {
          ordersPageNum--;
          ordersLastDoc = null;
          loadOrders(orderSearch.value, orderSort.value);
        }
      });
      nextOrders.addEventListener("click", () => {
        ordersPageNum++;
        loadOrders(orderSearch.value, orderSort.value);
      });
    }

    // Export Data
    function setupExport() {
      exportProductsBtn.addEventListener("click", () => exportData("products", "products.csv"));
      exportOrdersBtn.addEventListener("click", () => exportData("orders", "orders.csv"));
    }

    function exportData(collectionName, filename) {
      showLoader();
      onSnapshot(collection(db, collectionName), (snap) => {
        const data = [];
        snap.forEach(doc => data.push(doc.data()));
        const csv = convertToCSV(data);
        downloadCSV(csv, filename);
        hideLoader();
      });
    }

    function convertToCSV(data) {
      const headers = Object.keys(data[0] || {});
      const csv = [headers.join(",")];
      data.forEach(obj => csv.push(headers.map(header => obj[header] || "").join(",")));
      return csv.join("\n");
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: "text/csv" });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // Modals and CRUD
    function setupModalListeners(role) {
      const isFullAdmin = role === "full-admin";
      if (!isFullAdmin) {
        document.querySelectorAll(".edit-btn, .delete-btn, #addProductBtn").forEach(btn => btn.disabled = true);
      }

      addProductBtn.addEventListener("click", () => openModal(addProductModal));
      document.getElementById("closeAddModal").addEventListener("click", () => closeModal(addProductModal));
      document.getElementById("closeEditModal").addEventListener("click", () => closeModal(editProductModal));
      document.getElementById("closeOrderModal").addEventListener("click", () => closeModal(updateOrderModal));

      document.getElementById("addProductForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("addName").value;
        const price = parseFloat(document.getElementById("addPrice").value);
        const description = document.getElementById("addDesc").value;
        const file = document.getElementById("addImage").files[0];
        showLoader();
        try {
          const imageRef = ref(storage, `products/${Date.now()}_${file.name}`);
          await uploadBytes(imageRef, file);
          const imageUrl = await getDownloadURL(imageRef);
          await addDoc(collection(db, "products"), { name, price, description, imageUrl });
          closeModal(addProductModal);
          showNotification("Product added successfully!");
        } catch (err) {
          console.error("Add product error:", err);
          alert(`Error: ${err.message}`);
        }
        hideLoader();
      });

      document.getElementById("editProductForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("editId").value;
        const name = document.getElementById("editName").value;
        const price = parseFloat(document.getElementById("editPrice").value);
        const description = document.getElementById("editDesc").value;
        const file = document.getElementById("editImage").files[0];
        showLoader();
        try {
          const updates = { name, price, description };
          if (file) {
            const imageRef = ref(storage, `products/${Date.now()}_${file.name}`);
            await uploadBytes(imageRef, file);
            updates.imageUrl = await getDownloadURL(imageRef);
          }
          await updateDoc(doc(db, "products", id), updates);
          closeModal(editProductModal);
          showNotification("Product updated successfully!");
        } catch (err) {
          console.error("Edit product error:", err);
          alert(`Error: ${err.message}`);
        }
        hideLoader();
      });

      document.getElementById("updateOrderForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("orderId").value;
        const status = document.getElementById("orderStatus").value;
        showLoader();
        try {
          await updateDoc(doc(db, "orders", id), { status });
          closeModal(updateOrderModal);
          showNotification("Order status updated!");
        } catch (err) {
          console.error("Update order error:", err);
          alert(`Error: ${err.message}`);
        }
        hideLoader();
      });
    }

    function setupCardListeners() {
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const id = e.target.getAttribute("data-id");
          showLoader();
          const docSnap = await getDoc(doc(db, "products", id));
          const product = docSnap.data();
          document.getElementById("editId").value = id;
          document.getElementById("editName").value = product.name;
          document.getElementById("editPrice").value = product.price;
          document.getElementById("editDesc").value = product.description;
          openModal(editProductModal);
          hideLoader();
        });
      });

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const id = e.target.getAttribute("data-id");
          if (confirm("Are you sure?")) {
            showLoader();
            await deleteDoc(doc(db, "products", id));
            showNotification("Product deleted!");
            hideLoader();
          }
        });
      });

      document.querySelectorAll(".action-btn:not(.edit-btn):not(.delete-btn)").forEach(btn => {
        btn.addEventListener("click", (e) => {
          document.getElementById("orderId").value = e.target.getAttribute("data-id");
          document.getElementById("orderStatus").value = e.target.getAttribute("data-status");
          openModal(updateOrderModal);
        });
      });
    }

    // Note: getDoc was used incorrectly above, here's the corrected import and usage
    import { getDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
  </script>
</body>
</html>