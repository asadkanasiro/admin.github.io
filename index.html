<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Zindagi Perfumes</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #d4a017; /* Gold */
      --secondary: #2c3e50; /* Dark Blue */
      --accent: #ecf0f1; /* Light Gray */
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
    body { background: var(--accent); color: var(--secondary); line-height: 1.5; }
    .login-container, .admin-container { display: none; min-height: 100vh; }
    .login-container.active, .admin-container.active { display: block; }
    .login-card { background: #fff; padding: 2.5rem; border-radius: 8px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); width: 100%; max-width: 420px; margin: 0 auto; text-align: center; border: 2px solid var(--primary); }
    .login-card h2 { font-size: 1.75rem; font-weight: 500; margin-bottom: 2rem; color: var(--secondary); }
    .login-container input { width: 100%; padding: 0.85rem; margin: 0.75rem 0; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem; transition: border-color 0.3s; }
    .login-container input:focus { border-color: var(--primary); outline: none; }
    .login-container button, .action-btn { background: var(--primary); border: none; color: #fff; padding: 0.85rem 1.5rem; border-radius: 4px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background 0.3s; }
    .login-container button:hover, .action-btn:hover { background: #b58900; }
    .login-container button:disabled, .action-btn:disabled { background: #bdc3c7; cursor: not-allowed; }
    .error-message { color: #c0392b; margin-top: 1rem; font-size: 0.9rem; font-weight: 400; }
    .admin-container { padding: 1rem; }
    .sidebar { background: var(--secondary); color: var(--accent); position: fixed; top: 0; left: -280px; width: 280px; height: 100vh; transition: left 0.3s; z-index: 1001; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2); }
    .sidebar.active { left: 0; }
    .sidebar header { padding: 2rem 1.5rem; border-bottom: 1px solid #34495e; text-align: center; }
    .sidebar header img { max-width: 150px; margin-bottom: 1rem; }
    .sidebar header h2 { font-size: 1.5rem; font-weight: 700; color: var(--primary); letter-spacing: 0.5px; }
    .sidebar nav ul { list-style: none; padding: 1rem 0; }
    .sidebar nav ul li a { display: block; padding: 1rem 1.5rem; color: #bdc3c7; text-decoration: none; font-size: 1.1rem; font-weight: 400; transition: all 0.3s; }
    .sidebar nav ul li a:hover, .sidebar nav ul li a.active { background: #34495e; color: var(--primary); }
    .sidebar footer { padding: 1.5rem; border-top: 1px solid #34495e; }
    .sidebar footer button { width: 100%; background: var(--primary); border: none; color: #fff; padding: 0.85rem; border-radius: 4px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background 0.3s; }
    .sidebar footer button:hover { background: #b58900; }
    .menu-toggle { display: none; background: var(--secondary); color: var(--accent); border: none; padding: 1rem; font-size: 1.5rem; cursor: pointer; position: fixed; left: 1rem; top: 1rem; z-index: 1002; border-radius: 4px; }
    .menu-toggle:hover { background: #34495e; }
    .content { margin-left: 0; transition: margin-left 0.3s; }
    .content.active { margin-left: 280px; }
    .section { background: #fff; padding: 2rem; border-radius: 8px; border: 1px solid #e0e4e8; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 1.5rem; }
    .section h2 { font-size: 1.75rem; font-weight: 500; color: var(--secondary); margin-bottom: 1.5rem; }
    .search-bar { margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: center; }
    .search-bar input { width: 100%; max-width: 300px; padding: 0.85rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem; }
    .search-bar select { padding: 0.75rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem; }
    .stats-grid, .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card, .card { background: #fff; padding: 1.5rem; border-radius: 8px; border: 1px solid #e0e4e8; text-align: center; transition: box-shadow 0.3s; }
    .stat-card:hover, .card:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .stat-card span { display: block; font-size: 2.25rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; }
    .stat-card p, .card p { font-size: 1rem; color: #7f8c8d; font-weight: 400; }
    .card h4 { font-size: 1.2rem; font-weight: 500; color: var(--secondary); margin-bottom: 0.75rem; }
    .card .actions { margin-top: 1rem; }
    .card button { width: 100%; margin: 0.25rem 0; padding: 0.7rem; font-size: 0.9rem; }
    .action-btn.edit-btn { background: var(--primary); }
    .action-btn.edit-btn:hover { background: #b58900; }
    .action-btn.delete-btn { background: #c0392b; }
    .action-btn.delete-btn:hover { background: #a73125; }
    .export-btn { background: #3498db; margin-left: 1rem; }
    .export-btn:hover { background: #2980b9; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: #fff; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; position: relative; }
    .modal-content h3 { font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--secondary); }
    .modal-content label { display: block; margin: 0.75rem 0 0.25rem; font-weight: 500; }
    .modal-content input, .modal-content textarea, .modal-content select { width: 100%; padding: 0.75rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem; }
    .modal-content textarea { resize: vertical; min-height: 100px; }
    .modal-content button { margin-top: 1.5rem; }
    .close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #7f8c8d; }
    .loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(44, 62, 80, 0.9); color: #fff; padding: 1rem 2rem; border-radius: 4px; display: none; z-index: 1001; font-weight: 500; }
    .notifications { position: fixed; top: 1rem; right: 1rem; background: #fff; padding: 1rem; border-radius: 4px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); z-index: 1000; display: none; }
    .notification { padding: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #e0e4e8; font-size: 0.9rem; color: var(--secondary); }
    .chart-container { width: 100%; max-width: 600px; margin: 2rem auto; }
    .pagination { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem; }
    .pagination span { font-size: 1rem; color: var(--secondary); }
    @media (max-width: 768px) {
      .menu-toggle { display: block; }
      .sidebar { left: -280px; }
      .content { margin-left: 0; }
      .content.active { margin-left: 0; padding-top: 4rem; }
      .stats-grid, .cards-grid { grid-template-columns: 1fr; gap: 1rem; }
      .stat-card, .card { padding: 1rem; }
      .stat-card span { font-size: 1.8rem; }
      .stat-card p, .card p { font-size: 0.9rem; }
      .card h4 { font-size: 1.1rem; }
      .card button { padding: 0.6rem; font-size: 0.8rem; }
      .search-bar input { max-width: 100%; }
      .search-bar { flex-direction: column; align-items: flex-start; }
      .chart-container { max-width: 100%; }
    }
  </style>
</head>
<body>
  <!-- Login Form -->
  <div class="login-container" id="loginContainer">
    <div class="login-card">
      <h2>Admin Login</h2>
      <input type="email" id="email" placeholder="Email Address" />
      <input type="password" id="password" placeholder="Password" />
      <button id="loginBtn">Sign In</button>
      <div id="loginError" class="error-message"></div>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div class="admin-container" id="adminContainer">
    <button class="menu-toggle" id="menuToggle">☰</button>
    <aside class="sidebar">
      <header>
        <img src="path/to/zindagi-logo.png" alt="Zindagi Perfumes Logo">
        <h2>Zindagi Perfumes</h2>
      </header>
      <nav>
        <ul>
          <li><a href="#" data-section="dashboard" class="active">Dashboard</a></li>
          <li><a href="#" data-section="products">Products</a></li>
          <li><a href="#" data-section="orders">Orders</a></li>
        </ul>
      </nav>
      <footer><button id="logoutBtn">Sign Out</button></footer>
    </aside>
    <main class="content">
      <section id="dashboard" class="section">
        <h2>Dashboard</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <span id="totalProducts">0</span>
            <p>Total Products</p>
          </div>
          <div class="stat-card">
            <span id="totalOrders">0</span>
            <p>Total Orders</p>
          </div>
          <div class="stat-card">
            <span id="totalRevenue">0</span>
            <p>Total Revenue (PKR)</p>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="revenueChart"></canvas>
        </div>
      </section>
      <section id="products" class="section">
        <h2>Products</h2>
        <div class="search-bar">
          <input type="text" id="productSearch" placeholder="Search products..." />
          <select id="productSort">
            <option value="name_asc">Name (A-Z)</option>
            <option value="name_desc">Name (Z-A)</option>
            <option value="price_asc">Price (Low to High)</option>
            <option value="price_desc">Price (High to Low)</option>
          </select>
        </div>
        <button class="action-btn" id="addProductBtn">Add Product</button>
        <button class="action-btn export-btn" id="exportProductsBtn">Export Products</button>
        <div class="cards-grid" id="productsCards"></div>
        <div class="pagination">
          <button id="prevProducts" class="action-btn">Previous</button>
          <span id="productsPageNum">Page 1</span>
          <button id="nextProducts" class="action-btn">Next</button>
        </div>
      </section>
      <section id="orders" class="section">
        <h2>Orders</h2>
        <div class="search-bar">
          <input type="text" id="orderSearch" placeholder="Search orders..." />
          <select id="orderSort">
            <option value="orderId_asc">Order ID (Asc)</option>
            <option value="orderId_desc">Order ID (Desc)</option>
            <option value="amount_asc">Amount (Low to High)</option>
            <option value="amount_desc">Amount (High to Low)</option>
          </select>
        </div>
        <button class="action-btn export-btn" id="exportOrdersBtn">Export Orders</button>
        <div class="cards-grid" id="ordersCards"></div>
        <div class="pagination">
          <button id="prevOrders" class="action-btn">Previous</button>
          <span id="ordersPageNum">Page 1</span>
          <button id="nextOrders" class="action-btn">Next</button>
        </div>
      </section>
    </main>
  </div>

  <!-- Product Modals -->
  <div id="addProductModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeAddModal">×</button>
      <h3>Add Product</h3>
      <form id="addProductForm">
        <label for="addName">Name</label>
        <input type="text" id="addName" required />
        <label for="addPrice">Price (PKR)</label>
        <input type="number" id="addPrice" step="0.01" required />
        <label for="addDesc">Description</label>
        <textarea id="addDesc" required></textarea>
        <label for="addImage">Image</label>
        <input type="file" id="addImage" accept="image/*" required />
        <button type="submit" class="action-btn">Add Product</button>
      </form>
    </div>
  </div>
  <div id="editProductModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeEditModal">×</button>
      <h3>Edit Product</h3>
      <form id="editProductForm">
        <input type="hidden" id="editId" />
        <label for="editName">Name</label>
        <input type="text" id="editName" required />
        <label for="editPrice">Price (PKR)</label>
        <input type="number" id="editPrice" step="0.01" required />
        <label for="editDesc">Description</label>
        <textarea id="editDesc" required></textarea>
        <label for="editImage">Image (Optional)</label>
        <input type="file" id="editImage" accept="image/*" />
        <button type="submit" class="action-btn">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Order Status Modal -->
  <div id="updateOrderModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeOrderModal">×</button>
      <h3>Update Order Status</h3>
      <form id="updateOrderForm">
        <input type="hidden" id="orderId" />
        <label for="orderStatus">Status</label>
        <select id="orderStatus" required>
          <option value="Pending">Pending</option>
          <option value="Shipped">Shipped</option>
          <option value="Delivered">Delivered</option>
        </select>
        <button type="submit" class="action-btn">Update Status</button>
      </form>
    </div>
  </div>

  <div id="loader" class="loader">Loading...</div>
  <div id="notifications" class="notifications"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, getDocs, query, where, orderBy, limit, startAfter } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-storage.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC-sMxHYSiwld_U5GO7oGtHPw5CaVY_16s",
      authDomain: "zindagi-334b7.firebaseapp.com",
      projectId: "zindagi-334b7",
      storageBucket: "zindagi-334b7.firebasestorage.app",
      messagingSenderId: "936307521870",
      appId: "1:936307521870:web:619c050d865cff2ac9861f",
      measurementId: "G-B4HP267SJF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // DOM Elements
    const loginContainer = document.getElementById("loginContainer");
    const adminContainer = document.getElementById("adminContainer");
    const menuToggle = document.getElementById("menuToggle");
    const sidebar = document.querySelector(".sidebar");
    const content = document.querySelector(".content");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginError = document.getElementById("loginError");
    const loader = document.getElementById("loader");
    const notifications = document.getElementById("notifications");
    const addProductBtn = document.getElementById("addProductBtn");
    const addProductModal = document.getElementById("addProductModal");
    const editProductModal = document.getElementById("editProductModal");
    const updateOrderModal = document.getElementById("updateOrderModal");
    const closeAddModal = document.getElementById("closeAddModal");
    const closeEditModal = document.getElementById("closeEditModal");
    const closeOrderModal = document.getElementById("closeOrderModal");
    const addProductForm = document.getElementById("addProductForm");
    const editProductForm = document.getElementById("editProductForm");
    const updateOrderForm = document.getElementById("updateOrderForm");
    const productSearch = document.getElementById("productSearch");
    const orderSearch = document.getElementById("orderSearch");
    const productsCards = document.getElementById("productsCards");
    const ordersCards = document.getElementById("ordersCards");
    const exportProductsBtn = document.getElementById("exportProductsBtn");
    const exportOrdersBtn = document.getElementById("exportOrdersBtn");

    // Utility Functions
    const showLoader = () => loader.style.display = "block";
    const hideLoader = () => loader.style.display = "none";
    const showLogin = () => {
      loginContainer.classList.add("active");
      adminContainer.classList.remove("active");
    };
    const showAdmin = () => {
      loginContainer.classList.remove("active");
      adminContainer.classList.add("active");
    };
    const openModal = (modal) => {
      modal.classList.add("active");
      modal.querySelector("input, select").focus();
    };
    const closeModal = (modal) => modal.classList.remove("active");
    const toggleSidebar = () => {
      sidebar.classList.toggle("active");
      content.classList.toggle("active");
    };
    const showNotification = (message) => {
      const notification = document.createElement("div");
      notification.className = "notification";
      notification.textContent = message;
      notifications.appendChild(notification);
      notifications.style.display = "block";
      setTimeout(() => {
        notification.remove();
        if (!notifications.querySelector(".notification")) notifications.style.display = "none";
      }, 5000);
    };
    const debounce = (func, wait) => {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    };

    // Authentication State with Roles
    onAuthStateChanged(auth, (user) => {
      showLoader();
      if (user) {
        user.getIdTokenResult().then(idTokenResult => {
          const role = idTokenResult.claims.role;
          if (role === "full_admin" || role === "viewer") {
            showAdmin();
            initializeAdminDashboard();
            if (role === "viewer") {
              document.querySelectorAll(".action-btn:not(.export-btn)").forEach(btn => btn.disabled = true);
              addProductBtn.disabled = true;
            }
          } else {
            signOut(auth);
            showLogin();
            loginError.textContent = "Access denied. Admins only.";
          }
          hideLoader();
        }).catch(err => {
          console.error("Token error:", err);
          signOut(auth);
          showLogin();
          hideLoader();
        });
      } else {
        showLogin();
        hideLoader();
      }
    });

    // Login
    loginBtn.addEventListener("click", () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      showLoader();
      signInWithEmailAndPassword(auth, email, password)
        .then(() => loginError.textContent = "")
        .catch(err => {
          loginError.textContent = "Login failed: " + err.message;
          hideLoader();
        });
    });

    // Logout
    logoutBtn.addEventListener("click", () => signOut(auth));

    // Sidebar Toggle
    menuToggle.addEventListener("click", toggleSidebar);

    // Sidebar Navigation
    document.querySelectorAll('.sidebar nav ul li a').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const sectionId = link.getAttribute('data-section');
        document.querySelectorAll('.sidebar nav ul li a').forEach(n => n.classList.remove("active"));
        document.querySelectorAll('.section').forEach(s => s.classList.remove("active"));
        link.classList.add("active");
        document.getElementById(sectionId).classList.add("active");
        if (window.innerWidth <= 768) toggleSidebar();
      });
    });

    // Initialize Dashboard
    function initializeAdminDashboard() {
      loadDashboardStats();
      loadProducts();
      loadOrders();
      setupModalListeners();
      setupSearch();
      setupExport();
      setupNotifications();
      setupChart();
      setupPaginationAndSorting();
    }

    // Dashboard Stats and Chart
    function loadDashboardStats() {
      showLoader();
      const productsRef = collection(db, "products");
      const ordersRef = collection(db, "orders");
      onSnapshot(productsRef, (snap) => {
        document.getElementById("totalProducts").textContent = snap.size;
      });
      onSnapshot(ordersRef, (snap) => {
        document.getElementById("totalOrders").textContent = snap.size;
        let totalRevenue = 0;
        const revenueData = [];
        snap.forEach(doc => {
          const order = doc.data();
          totalRevenue += order.amount || 0;
          revenueData.push({ x: doc.id, y: order.amount || 0 });
        });
        document.getElementById("totalRevenue").textContent = totalRevenue.toFixed(2);
        updateChart(revenueData);
        hideLoader();
      });
    }

    function setupChart() {
      const ctx = document.getElementById("revenueChart").getContext("2d");
      window.revenueChart = new Chart(ctx, {
        type: "line",
        data: { datasets: [{ label: "Revenue (PKR)", data: [], borderColor: "#d4a017", fill: false }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: "Orders" } }, y: { beginAtZero: true, title: { display: true, text: "Amount (PKR)" } } } }
      });
    }

    function updateChart(data) {
      if (window.revenueChart) {
        window.revenueChart.data.datasets[0].data = data;
        window.revenueChart.update();
      }
    }

    // Load Products and Orders with Pagination
    async function loadPaginatedData(collectionName, containerId, perPage = 5, page = 1, sort = "name_asc", searchQuery = "", lastDoc = null) {
      showLoader();
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      let [sortField, sortDir] = sort.split("_");
      sortField = collectionName === "products" ? (sortField === "name" ? "name" : "price") : (sortField === "orderId" ? "orderId" : "amount");

      let q = query(
        collection(db, collectionName),
        orderBy(sortField, sortDir),
        limit(perPage)
      );
      if (lastDoc && page > 1) q = query(q, startAfter(lastDoc));

      const snap = await getDocs(q);
      if (snap.empty) {
        container.innerHTML = "<p>No items found.</p>";
        hideLoader();
        return null;
      }

      snap.forEach(doc => {
        const item = { id: doc.id, ...doc.data() };
        if (searchQuery && !(item[sortField] || item.id).toLowerCase().includes(searchQuery.toLowerCase())) return;
        const card = document.createElement("div");
        card.className = "card";
        if (collectionName === "products") {
          card.innerHTML = `
            <h4>${item.name}</h4>
            <p><strong>Price:</strong> ${item.price.toFixed(2)} PKR</p>
            <p><strong>Description:</strong> ${item.description || "N/A"}</p>
            ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}" style="max-width: 100%; border-radius: 4px; margin: 0.5rem 0;">` : ""}
            <div class="actions">
              <button class="action-btn edit-btn" data-id="${item.id}">Edit</button>
              <button class="action-btn delete-btn" data-id="${item.id}">Delete</button>
            </div>
          `;
        } else {
          card.innerHTML = `
            <h4>Order #${item.orderId || item.id}</h4>
            <p><strong>Customer:</strong> ${item.customerEmail || "Unknown"}</p>
            <p><strong>Amount:</strong> ${item.amount.toFixed(2)} PKR</p>
            <p><strong>Status:</strong> ${item.status || "Pending"}</p>
            <div class="actions">
              <button class="action-btn" data-id="${item.id}" data-status="${item.status || "Pending"}">Update Status</button>
            </div>
          `;
        }
        container.appendChild(card);
      });
      setupCardListeners();
      hideLoader();

      document.getElementById(`${containerId === "productsCards" ? "products" : "orders"}PageNum`).textContent = `Page ${page}`;
      return snap.docs[snap.docs.length - 1];
    }

    // Pagination and Sorting Setup
    function setupPaginationAndSorting() {
      let productsPage = 1, ordersPage = 1, productsLastDoc = null, ordersLastDoc = null;
      const perPage = 5;

      // Products
      document.getElementById("prevProducts").addEventListener("click", async () => {
        if (productsPage > 1) {
          productsPage--;
          productsLastDoc = await loadPaginatedData("products", "productsCards", perPage, productsPage, document.getElementById("productSort").value, productSearch.value, productsPage > 1 ? productsLastDoc : null);
        }
      });
      document.getElementById("nextProducts").addEventListener("click", async () => {
        productsPage++;
        productsLastDoc = await loadPaginatedData("products", "productsCards", perPage, productsPage, document.getElementById("productSort").value, productSearch.value, productsLastDoc);
      });
      document.getElementById("productSort").addEventListener("change", async (e) => {
        productsPage = 1;
        productsLastDoc = null;
        productsLastDoc = await loadPaginatedData("products", "productsCards", perPage, productsPage, e.target.value, productSearch.value);
      });
      productSearch.addEventListener("input", debounce(async (e) => {
        productsPage = 1;
        productsLastDoc = null;
        productsLastDoc = await loadPaginatedData("products", "productsCards", perPage, productsPage, document.getElementById("productSort").value, e.target.value);
      }, 300));

      // Orders
      document.getElementById("prevOrders").addEventListener("click", async () => {
        if (ordersPage > 1) {
          ordersPage--;
          ordersLastDoc = await loadPaginatedData("orders", "ordersCards", perPage, ordersPage, document.getElementById("orderSort").value, orderSearch.value, ordersPage > 1 ? ordersLastDoc : null);
        }
      });
      document.getElementById("nextOrders").addEventListener("click", async () => {
        ordersPage++;
        ordersLastDoc = await loadPaginatedData("orders", "ordersCards", perPage, ordersPage, document.getElementById("orderSort").value, orderSearch.value, ordersLastDoc);
      });
      document.getElementById("orderSort").addEventListener("change", async (e) => {
        ordersPage = 1;
        ordersLastDoc = null;
        ordersLastDoc = await loadPaginatedData("orders", "ordersCards", perPage, ordersPage, e.target.value, orderSearch.value);
      });
      orderSearch.addEventListener("input", debounce(async (e) => {
        ordersPage = 1;
        ordersLastDoc = null;
        ordersLastDoc = await loadPaginatedData("orders", "ordersCards", perPage, ordersPage, document.getElementById("orderSort").value, e.target.value);
      }, 300));

      // Initial Loads
      loadPaginatedData("products", "productsCards", perPage, productsPage, "name_asc").then(doc => productsLastDoc = doc);
      loadPaginatedData("orders", "ordersCards", perPage, ordersPage, "orderId_asc").then(doc => ordersLastDoc = doc);
    }

    // Load Products Alias (for compatibility)
    function loadProducts() {}
    function loadOrders() {}

    // Product and Order Management
    function setupModalListeners() {
      addProductBtn.addEventListener("click", () => {
        addProductForm.reset();
        openModal(addProductModal);
      });
      closeAddModal.addEventListener("click", () => closeModal(addProductModal));
      closeEditModal.addEventListener("click", () => closeModal(editProductModal));
      closeOrderModal.addEventListener("click", () => closeModal(updateOrderModal));

      addProductForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("addName").value;
        const price = parseFloat(document.getElementById("addPrice").value);
        const description = document.getElementById("addDesc").value;
        const imageFile = document.getElementById("addImage").files[0];

        if (price <= 0) {
          alert("Price must be positive.");
          return;
        }
        if (!imageFile) {
          alert("Please select an image.");
          return;
        }

        showLoader();
        try {
          const storageRef = ref(storage, `products/${Date.now()}_${imageFile.name}`);
          await uploadBytes(storageRef, imageFile);
          const imageUrl = await getDownloadURL(storageRef);
          const productData = { name, price, description, imageUrl };
          await addDoc(collection(db, "products"), productData);
          closeModal(addProductModal);
          showNotification("Product added successfully!");
        } catch (err) {
          alert("Failed to add product: " + err.message);
        }
        hideLoader();
      });

      editProductForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("editId").value;
        const name = document.getElementById("editName").value;
        const price = parseFloat(document.getElementById("editPrice").value);
        const description = document.getElementById("editDesc").value;
        const imageFile = document.getElementById("editImage").files[0];

        if (price <= 0) {
          alert("Price must be positive.");
          return;
        }

        showLoader();
        try {
          const productData = { name, price, description };
          if (imageFile) {
            const storageRef = ref(storage, `products/${Date.now()}_${imageFile.name}`);
            await uploadBytes(storageRef, imageFile);
            productData.imageUrl = await getDownloadURL(storageRef);
          }
          await updateDoc(doc(db, "products", id), productData);
          closeModal(editProductModal);
          showNotification("Product updated successfully!");
        } catch (err) {
          alert("Failed to update product: " + err.message);
        }
        hideLoader();
      });

      updateOrderForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("orderId").value;
        const status = document.getElementById("orderStatus").value;
        showLoader();
        try {
          await updateDoc(doc(db, "orders", id), { status });
          closeModal(updateOrderModal);
          showNotification("Order status updated successfully!");
        } catch (err) {
          alert("Failed to update order status: " + err.message);
        }
        hideLoader();
      });
    }

    function setupCardListeners() {
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const id = e.target.getAttribute("data-id");
          const productRef = doc(db, "products", id);
          showLoader();
          const docSnap = await getDocs(productRef);
          const product = docSnap.data();
          document.getElementById("editId").value = id;
          document.getElementById("editName").value = product.name;
          document.getElementById("editPrice").value = product.price;
          document.getElementById("editDesc").value = product.description || "";
          document.getElementById("editImage").value = "";
          openModal(editProductModal);
          hideLoader();
        });
      });

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.target.getAttribute("data-id");
          if (confirm("Are you sure you want to delete this product?")) {
            showLoader();
            deleteDoc(doc(db, "products", id))
              .then(() => showNotification("Product deleted successfully!"))
              .catch(err => alert("Failed to delete product: " + err.message))
              .finally(() => hideLoader());
          }
        });
      });

      document.querySelectorAll(".action-btn:not(.edit-btn):not(.delete-btn)").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.target.getAttribute("data-id");
          const status = e.target.getAttribute("data-status");
          document.getElementById("orderId").value = id;
          document.getElementById("orderStatus").value = status;
          openModal(updateOrderModal);
        });
      });
    }

    // Export Data
    function setupExport() {
      exportProductsBtn.addEventListener("click", () => exportData("products", "products.csv"));
      exportOrdersBtn.addEventListener("click", () => exportData("orders", "orders.csv"));
    }

    function exportData(collectionName, filename) {
      showLoader();
      onSnapshot(collection(db, collectionName), (snap) => {
        const data = [];
        snap.forEach(doc => data.push(doc.data()));
        const csv = convertToCSV(data);
        downloadCSV(csv, filename);
        hideLoader();
      });
    }

    function convertToCSV(data) {
      const headers = Object.keys(data[0] || {});
      const csv = [headers.join(",")];
      data.forEach(obj => csv.push(headers.map(header => obj[header] || "").join(",")));
      return csv.join("\n");
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: "text/csv" });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // Real-Time Notifications
    function setupNotifications() {
      onSnapshot(collection(db, "orders"), (snap) => {
        snap.docChanges().forEach(change => {
          if (change.type === "added") {
            showNotification(`New order #${change.doc.data().orderId || change.doc.id} received!`);
          }
        });
      });
    }

    // Search Functionality Alias (handled in setupPaginationAndSorting)
    function setupSearch() {}
  </script>
</body>
</html>